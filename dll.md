<h1>DLL注入(一):生成DLL文件</h1>

<h3>1.什么是DLL文件</h3>

<blockquote>DLL:意为动态链接库。在Windows中，许多应用程序并不是一个完整的可执行文件，它们被分割成一些相对独立的动态链接库，即DLL文件，放置于系统中.当我们执行某一个程序时，相应的DLL文件就会被调用.一个应用程序可有多个DLL文件，一个DLL文件也可能被几个应用程序所共用，这样的DLL文件被称为共享DLL文件.注意:DLL中通常没有用来创建窗口或者处理消息循环的支持代码,他只是一个源代码的模块.</blockquote>


<h3>2.为什么要使用DLL</h3>
1. 扩展了应用程序的特性:由于DLL能够动态地装入进程的地址空间，因此应用程序 能够在运行时确定需要执行什么操作然后装入相应的代码以便根据需要执行这些操作.
2. 它们有助于节省内存.如果两个或多个应用程序使用同一个DLL那么该DLL的页面只要放入RAM一次所有的应用程序都可以共享它的各个页面.
3. 它们有助于资源的共享。DLL可以包含对话框模板、字符串、图标和位图等资源。多个应用程序能够使用DLL来共享这些资源。

<h3>3.创建一个DLL文件</h3>
<blockquote>对于一个DLL来说,你必须设定该链接程序的DLL开关,这个开关使得连接程序能够向产生的DLL文件映像发出不同的信息,这样操作系统加载程序就能将该文件映像视为一个DLL而不是应用程序.在应用程序能够调用DLL中的函数之前,DLL文件映像必须被映射到调用进程的虚拟地址空间中(加载时的隐式链接或运行时的显示链接).</blockquote>

<h4>创建DLL:</h4>
1. 建立带有输出原型/结构/符号的头文件。
2. 建立实现输出函数/变量的C/C++源文件。 
3. 编译器为每个C/C++源文件生成 .obj模块。
4. 链接程序将生成DLL的 .obj模块链接起来。
5. 如果至少输出一个函数/变量，那么链接程序也生成lib 文件。
6. **编译即可生成可利用的dll文件**

<h4>创建exe:</h4>
1. 建立带有输入原型/结构/符号的头文件。
2. 建立引用输入函数/变量的C/C++源文件。
3. 编译器为每个C/C++源文件生成 .obj源文件。
4. 链接程序将各个 .obj模块链接起来，产生一个.exe文件(它包含了所需要DLL模块的名字和输入符号的列表)。

<h4>运行应用程序:</h4> 
1. 加载程序为.exe创建地址空间。
2. 加载程序将需要的DLL加载到地址空间中进程的主线程开始执行,应用程序启动运行.

<h3>4.虚拟地址空间</h3>
<blockquote>当处理器读或写入内存位置时,它会使用虚拟地址.作为读或写操作的一部分,处理器会将虚拟地址转换为物理地址</blockquote>

<h4>优点:</h4>
1. 程序可以使用一系列相邻的虚拟地址来访问物理内存中不相邻的大内存缓冲区.
2. 程序可以使用一系列虚拟地址来访问大于可用物理内存的内存缓冲区。当物理内存的供应量变小时，内存管理器会将物理内存页（通常大小为 4 KB）保存到磁盘文件。数据或代码页会根据需要在物理内存与磁盘之间移动。
3. 不同进程使用的虚拟地址彼此隔离。一个进程中的代码无法更改正在由另一进程或操作系统使用的物理内存。




<h3>5.DllMain简介</h3>
跟exe有个main或者WinMain入口函数一样，DLL也有一个入口函数，就是DllMain,不过需要注意该函数是可选的.当程序中存在静态链接,或动态链接调用LoadLibrary和FreeLibirary时都会调用DllMain函数.

![dll1.PNG](https://i.loli.net/2018/10/02/5bb36300e2afd.png)

这里的第三个参数fdwReason指明了系统调用dll的原因,他可能是DLL_PROCESS_ATTACH、DLL_PROCESS_DETACH、DLL_THREAD_ATTACH或者DLL_THREAD_DETACH,我们一般用到的就是第一个.
>DLL_PROCESS_ATTACH:一个程序要调用Dll里的函数，首先要先把DLL文件映射到进程的地址空间。要把一个DLL文件映射到进程的地址空间，有两种方法：静态链接和动态链接的LoadLibrary或者LoadLibraryEx。DLL_PROCESS_ATTACH就表示由于进程启动或**由于调用LoadLibrary或者LoadLibraryEx**而将DLL加载到当前进程的虚拟地址空间。
